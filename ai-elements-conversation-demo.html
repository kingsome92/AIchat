<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½æ•™å­¦åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* å·¦ä¾§ä¾§è¾¹æ  */
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        .menu-list {
            flex: 1;
            padding: 8px 0;
            overflow-y: auto;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item.active {
            background: #e8e8e8;
            color: #1890ff;
            font-weight: 500;
        }

        .menu-demo-tag {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #f97316;
            font-size: 10px;
            color: #ea580c;
            background: #fff7ed;
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid #f0f0f0;
        }

        .footer-btn {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            color: #666;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            margin-bottom: 8px;
        }

        .footer-btn:last-child {
            margin-bottom: 0;
        }

        .footer-btn:hover {
            background: #f5f5f5;
            border-color: #1890ff;
            color: #1890ff;
        }

        /* å³ä¾§ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .content-header {
            background: white;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header-left {
            flex: 1;
        }

        .content-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .content-header p {
            font-size: 13px;
            color: #999;
        }

        .content-header-actions {
            display: flex;
            gap: 8px;
        }

        .header-action-btn {
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            color: #666;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-action-btn:hover {
            background: #f5f5f5;
            border-color: #1890ff;
            color: #1890ff;
        }

        .header-action-btn.primary {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .header-action-btn.primary:hover {
            background: #40a9ff;
        }

        .content-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* èŠå¤©ç•Œé¢æ ·å¼ */
        .chat-container {
            position: fixed;
            right: 32px;
            bottom: 40px;
            top: 40px;
            width: 420px;
            max-width: calc(100% - 80px);
            display: none;
            flex-direction: column;
            background: #fafafa;
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
            z-index: 900;
            overflow: hidden;
        }

        .chat-header {
            flex-shrink: 0;
            padding: 16px 20px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .chat-header-left {
            min-width: 0;
        }

        .chat-header-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .chat-header-subtitle {
            font-size: 12px;
            color: #6b7280;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-header-btn {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-header-btn:hover {
            background: #eef2ff;
            border-color: #6366f1;
            color: #3730a3;
        }

        .chat-header-icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            transition: all 0.2s;
        }

        .chat-header-icon-btn:hover {
            background: #fee2e2;
            border-color: #f87171;
            color: #b91c1c;
        }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        ai-message {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 75%;
            margin-bottom: 16px;
        }

        .message > div:last-child {
            flex: 1;
            min-width: 0;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #00d4ff 0%, #5b8def 100%);
            color: white;
        }

        .message-content {
            background: #e5e7eb;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-content {
            background: #e5e7eb;
            color: #111827;
        }

        .message.assistant .message-content {
            background: #e5e7eb;
            color: #111827;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .message.user .message-time {
            text-align: left;
        }

        .message.assistant .message-time {
            text-align: left;
        }

        /* ä»»åŠ¡æ¸…å•æ ·å¼ */
        .task-list {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #1890ff;
        }

        .task-list-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 13px;
            color: #666;
        }

        .task-item:last-child {
            margin-bottom: 0;
        }

        .task-checkbox {
            margin-top: 2px;
            flex-shrink: 0;
        }

        /* æ¶ˆæ¯å†…æ“ä½œæŒ‰é’®ç»„ */
        .message-actions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .message-action-btn {
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid #d4d4d8;
            background: #ffffff;
            font-size: 12px;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
        }

        .message-action-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .message-action-btn.primary {
            background: #111827;
            border-color: #111827;
            color: #ffffff;
        }

        .message-action-btn.primary:hover {
            background: #020617;
            border-color: #020617;
        }

        /* å·¥å…·è°ƒç”¨ç›‘æ§åˆ—è¡¨ */
        .tool-monitor {
            margin-top: 12px;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 8px;
            border: 1px solid #d4e9ff;
        }

        .tool-monitor-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .tool-item {
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tool-item:last-child {
            margin-bottom: 0;
        }

        .tool-status {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .tool-status.success {
            background: #f6ffed;
            color: #52c41a;
        }

        .tool-status.processing {
            background: #fff7e6;
            color: #faad14;
        }

        /* é¡µé¢å·¥ä½œåŒºå ä½ï¼Œç”¨äºæ¨¡æ‹Ÿä¸šåŠ¡é¡µé¢ */
        .page-work-area {
            flex: 1;
            background: #f0f2f5;
            border-radius: 12px;
            margin: 16px 24px 24px;
            border: 1px dashed #d4d4d8;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 14px;
        }

        .page-work-area-inner {
            text-align: center;
        }

        .page-work-area-title {
            font-size: 16px;
            margin-bottom: 6px;
            color: #6b7280;
        }

        .page-work-area-desc {
            font-size: 12px;
            color: #9ca3af;
        }

        /* è¾“å…¥åŒºåŸŸ */
        ai-prompt-input {
            display: block;
            border-top: 1px solid #e0e0e0;
            background: white;
            flex-shrink: 0;
        }

        .prompt-input-container {
            padding: 16px 20px 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .system-shortcuts {
            display: flex;
            gap: 12px;
        }

        .system-shortcut-btn {
            flex: 1;
            height: 34px;
            border-radius: 999px;
            border: 1px solid #d4d4d8;
            background: #ffffff;
            font-size: 13px;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s;
        }

        .system-shortcut-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .prototype-input-shell {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 12px;
            border-radius: 999px;
            background: #f5f5f5;
            border: 1px solid #e5e7eb;
        }

        .prompt-input-wrapper {
            flex: 1;
            position: relative;
        }

        .prompt-input {
            width: 100%;
            min-height: 34px;
            max-height: 80px;
            padding: 8px 4px;
            border: none;
            border-radius: 999px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            background: transparent;
        }

        .prompt-input::placeholder {
            color: #9ca3af;
        }

        .voice-button,
        .file-upload-btn,
        .send-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #d4d4d8;
            background: #ffffff;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .voice-button svg,
        .file-upload-btn svg,
        .send-button svg {
            width: 16px;
            height: 16px;
        }

        .voice-button:hover,
        .file-upload-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .send-button {
            background: #111827;
            color: #ffffff;
            border-color: #111827;
        }

        .send-button:hover:not(:disabled) {
            background: #020617;
            border-color: #020617;
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
        }

        .file-upload-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #e0e0e0;
            border-radius: 50%;
            background: white;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .file-upload-btn:hover {
            background: #f5f5f5;
            border-color: #1890ff;
            color: #1890ff;
        }

        .file-upload-btn svg {
            width: 20px;
            height: 20px;
        }

        .file-input {
            display: none;
        }

        .bottom-hint {
            margin-top: 2px;
            font-size: 11px;
            color: #9ca3af;
            text-align: center;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 100px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1890ff;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* é…ç½®é¢æ¿æ ·å¼ - Ant Designé£æ ¼ */
        .config-panel {
            display: none;
            flex-direction: column;
            height: 100%;
            background: #f5f5f5;
            padding: 24px;
            overflow-y: auto;
        }

        .config-panel.active {
            display: flex;
        }

        .config-status {
            background: #fff;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.02);
        }

        .config-status-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .config-status-label {
            font-weight: 600;
            color: #262626;
            font-size: 16px;
        }

        .config-status-left > span:last-child {
            color: #595959;
            font-size: 14px;
        }

        .config-status-right {
            color: #8c8c8c;
            font-size: 13px;
        }

        .config-form {
            background: #fff;
            border-radius: 6px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #262626;
            line-height: 1.5715;
        }

        .form-label::before {
            display: inline-block;
            margin-right: 4px;
            color: #ff4d4f;
            font-size: 14px;
            font-family: SimSun, sans-serif;
            line-height: 1;
            content: '*';
        }

        .form-label.optional::before {
            content: '';
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 6.5px 11px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5715;
            color: rgba(0, 0, 0, 0.88);
            transition: all 0.2s;
            outline: none;
            background-color: #fff;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: #4096ff;
            box-shadow: 0 0 0 2px rgba(5, 145, 255, 0.1);
        }

        .form-input:disabled,
        .form-select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: rgba(0, 0, 0, 0.25);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
            padding: 6.5px 11px;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #1890ff;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.88);
            margin: 0;
        }

        .radio-group {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #1890ff;
        }

        .radio-item label {
            cursor: pointer;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.88);
            margin: 0;
        }

        .tag-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 12px;
            background: #f0f0f0;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            color: rgba(0, 0, 0, 0.88);
            line-height: 20px;
            cursor: default;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 6.4px 15px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5715;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            color: rgba(0, 0, 0, 0.88);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.02);
        }

        .btn:hover {
            color: #4096ff;
            border-color: #4096ff;
        }

        .btn:active {
            color: #0958d9;
            border-color: #0958d9;
        }

        .btn-primary {
            background: #1890ff;
            color: #fff;
            border-color: #1890ff;
            box-shadow: 0 2px 0 rgba(5, 145, 255, 0.1);
        }

        .btn-primary:hover {
            background: #40a9ff;
            border-color: #40a9ff;
        }

        .btn-primary:active {
            background: #0958d9;
            border-color: #0958d9;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-content::-webkit-scrollbar,
        .config-panel::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .chat-content::-webkit-scrollbar-track,
        .config-panel::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-content::-webkit-scrollbar-thumb,
        .config-panel::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .chat-content::-webkit-scrollbar-thumb:hover,
        .config-panel::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ */
        .image-preview {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
                font-size: 12px;
        }

        /* ä½œä¸šé¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .homework-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .homework-preview-modal.active {
            display: flex;
        }

        .homework-preview-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .homework-preview-header {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .homework-preview-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.88);
        }

        .homework-preview-close {
            width: 22px;
            height: 22px;
            border: none;
            background: transparent;
            font-size: 18px;
            color: rgba(0, 0, 0, 0.45);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .homework-preview-close:hover {
            background: #f5f5f5;
            color: rgba(0, 0, 0, 0.88);
        }

        .homework-preview-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .preview-item {
            margin-bottom: 20px;
        }

        .preview-item:last-child {
            margin-bottom: 0;
        }

        .preview-label {
            font-weight: 600;
            color: rgba(0, 0, 0, 0.88);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .preview-value {
            color: rgba(0, 0, 0, 0.65);
            font-size: 14px;
            line-height: 1.5715;
        }

        .preview-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preview-tag {
            padding: 4px 12px;
            background: #f0f0f0;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            color: rgba(0, 0, 0, 0.88);
        }

        .homework-view-btn:hover {
            background: #40a9ff !important;
            box-shadow: 0 2px 4px rgba(5, 145, 255, 0.2);
        }

        /* æ‚¬æµ®ä¸»å…¥å£ */
        .ai-fab {
            position: fixed;
            right: 40px;
            bottom: 40px;
            z-index: 950;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .ai-fab-main {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: none;
            background: radial-gradient(circle at 30% 30%, #f9fafb 0, #e5e7eb 25%, #4f46e5 70%, #7c3aed 100%);
            color: #ffffff;
            box-shadow: 0 12px 30px rgba(88, 80, 236, 0.55);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        }

        .ai-fab-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 40px rgba(79, 70, 229, 0.75);
        }

        .ai-fab-main span {
            font-size: 11px;
            opacity: 0.9;
        }

        .ai-fab-menu {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .ai-fab-menu.open {
            display: flex;
        }

        .ai-fab-item {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.2);
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .ai-fab-item:hover {
            border-color: #6366f1;
            color: #3730a3;
            background: #eef2ff;
        }

        .ai-fab-item-tag {
            padding: 2px 6px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
            font-size: 10px;
        }

        /* æˆ‘çš„ç©ºé—´ */
        .my-space-panel {
            position: absolute;
            inset: 0;
            background: #f5f5f5;
            display: none;
            z-index: 10;
        }

        .chat-container.my-space-open .my-space-panel {
            display: flex;
        }

        .chat-container.my-space-open .chat-header,
        .chat-container.my-space-open .chat-content,
        .chat-container.my-space-open ai-prompt-input {
            display: none;
        }

        .my-space-content {
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
        }

        .my-space-header {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            gap: 16px;
        }

        .my-space-back {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 12px;
            cursor: pointer;
            color: #374151;
            transition: all 0.2s;
        }

        .my-space-back:hover {
            background: #eff6ff;
            border-color: #60a5fa;
            color: #1d4ed8;
        }

        .my-space-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            flex: 1;
        }

        .my-space-tabs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .my-space-tab {
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid transparent;
            background: transparent;
            font-size: 13px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .my-space-tab.active {
            background: #eff6ff;
            border-color: #60a5fa;
            color: #1d4ed8;
        }

        .my-space-body {
            padding: 20px 24px 24px;
            overflow-y: auto;
        }

        .my-space-section {
            display: none;
        }

        .my-space-section.active {
            display: block;
        }

        .my-settings-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .my-setting-card {
            background: #ffffff;
            border-radius: 10px;
            padding: 16px 18px;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .my-setting-meta {
            flex: 1;
        }

        .my-setting-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }

        .my-setting-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .my-setting-tags {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .my-setting-tag {
            padding: 2px 8px;
            border-radius: 999px;
            background: #eff6ff;
            font-size: 11px;
            color: #1d4ed8;
        }

        .toggle-switch {
            position: relative;
            width: 42px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #e5e7eb;
            border-radius: 999px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            top: 2px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.3);
            transition: 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #4ade80;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .resources-group {
            margin-bottom: 24px;
        }

        .resources-group-title {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .resource-card {
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            font-size: 12px;
            color: #374151;
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .resource-card:hover {
            border-color: #6366f1;
            box-shadow: 0 6px 18px rgba(79, 70, 229, 0.25);
        }

        .resource-name {
            font-weight: 500;
        }

        .resource-meta {
            font-size: 11px;
            color: #9ca3af;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .message {
                max-width: 85%;
            }

            .homework-preview-content {
                width: 95%;
                max-height: 95vh;
            }

            .chat-container {
                right: 16px;
                left: 16px;
                width: auto;
                top: 16px;
                bottom: 80px;
            }

            .ai-fab {
                right: 20px;
                bottom: 24px;
            }

            .my-space-content {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div style="font-weight: 600; color: #333; margin-bottom: 4px;">AIæ™ºèƒ½æ•™å­¦åŠ©æ‰‹</div>
            <div style="font-size: 12px;">é€‰æ‹©åŠŸèƒ½æ¨¡å—</div>
        </div>
        <div class="menu-list">
            <div class="menu-item" data-function="history">
                <span>ğŸ“‹</span>
                <span>ä¼šè¯è®°å½•</span>
            </div>
            <div class="menu-item" data-function="prep">
                <span>ğŸ“š</span>
                <span>ä¸€é”®å¤‡è¯¾</span>
            </div>
            <div class="menu-item active" data-function="homework">
                <span>ğŸ“</span>
                <span>ä½œä¸šå¸ƒç½®</span>
                <span class="menu-demo-tag">demo</span>
            </div>
            <div class="menu-item" data-function="analysis">
                <span>ğŸ“Š</span>
                <span>å­¦æƒ…åˆ†æ</span>
                <span class="menu-demo-tag">demo</span>
            </div>
            <div class="menu-item" data-function="imageEnhance">
                <span>ğŸ–¼ï¸</span>
                <span>å›¾ç‰‡ç¾åŒ–</span>
                <span class="menu-demo-tag">demo</span>
            </div>
            <div class="menu-item" data-function="grading">
                <span>âœï¸</span>
                <span>ä½œæ–‡æ‰¹æ”¹</span>
            </div>
            <div class="menu-item" data-function="export">
                <span>ğŸ“¤</span>
                <span>æˆç»©å¯¼å‡º</span>
            </div>
            <div class="menu-item" data-function="video">
                <span>ğŸ¥</span>
                <span>AIè§†é¢‘è®²é¢˜</span>
            </div>
            <div class="menu-item" data-function="ppt">
                <span>ğŸ“„</span>
                <span>è¯¾ä»¶PPT</span>
            </div>
            <div class="menu-item" data-function="graphics">
                <span>ğŸ“</span>
                <span>æ•°å­¦å›¾å½¢è®¾è®¡</span>
            </div>
            <div class="menu-item" data-function="grouping">
                <span>ğŸ‘¥</span>
                <span>æ™ºèƒ½åˆ†ç»„</span>
            </div>
            <div class="menu-item" data-function="plan">
                <span>ğŸ“…</span>
                <span>æ•™å­¦è®¡åˆ’</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="footer-btn" id="myBtn">æˆ‘çš„</button>
        </div>
        </div>

    <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="content-header">
            <div class="content-header-left">
                <h2 id="functionTitle">ä½œä¸šå¸ƒç½®</h2>
                <p id="functionSubtitle">AIè‡ªåŠ¨å¸ƒç½®ä½œä¸š,è¯·æè¿°æ‚¨çš„è¦æ±‚å§</p>
            </div>
            <div class="content-header-actions" id="headerActions">
                <button class="header-action-btn" id="historyBtn" title="å†å²è®°å½•">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span>å†å²è®°å½•</span>
                </button>
                <button class="header-action-btn primary" id="newChatBtn" title="æ–°å»ºä¼šè¯">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>ä¼šè¯</span>
                </button>
            </div>
        </div>
        <div class="content-body">
            <div class="page-work-area">
                <div class="page-work-area-inner">
                    <div class="page-work-area-title">é¡µé¢å·¥ä½œåŒº</div>
                    <div class="page-work-area-desc">è¿™é‡Œæ˜¯ä¸šåŠ¡å†…å®¹åŒºåŸŸï¼ŒAI åŠ©æ‰‹ä»¥æ‚¬æµ®å…¥å£å½¢å¼åµŒå…¥åœ¨é¡µé¢ä¾§è¾¹ã€‚</div>
                </div>
            </div>

            <!-- èŠå¤©ä¾§æ çª—å£ -->
            <div class="chat-container" id="chatContainer">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="chat-header-title" id="chatFeatureTitle">AIåŠ©æ‰‹ Â· å­¦æƒ…åˆ†æ</div>
                        <div class="chat-header-subtitle" id="chatFeatureSubtitle">æ™ºèƒ½æ´å¯Ÿç­çº§å­¦ä¹ æƒ…å†µï¼Œæ²‰æ·€åˆ†æç»“è®ºä¸å»ºè®®</div>
                    </div>
                    <div class="chat-header-right">
                        <button class="chat-header-btn" id="chatMySpaceBtn">æˆ‘çš„ç©ºé—´</button>
                        <button class="chat-header-icon-btn" id="chatCloseBtn" aria-label="å…³é—­å¯¹è¯">Ã—</button>
                    </div>
                </div>

                <div class="chat-content" id="chatContent">
                </div>

                <ai-prompt-input>
                    <div class="prompt-input-container">
                        <div class="system-shortcuts">
                            <button class="system-shortcut-btn" id="systemFunc1Btn">ç³»ç»ŸåŠŸèƒ½1</button>
                            <button class="system-shortcut-btn" id="systemFunc2Btn">ç³»ç»ŸåŠŸèƒ½2</button>
                        </div>
                        <div class="prototype-input-shell">
                            <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                            <button class="file-upload-btn" id="fileUploadBtn" type="button" title="ä¸Šä¼ å›¾ç‰‡">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </button>
                            <div class="prompt-input-wrapper">
                                <textarea
                                    id="promptInput"
                                    class="prompt-input"
                                    placeholder="è¯·è¾“å…¥æ‚¨çš„éœ€æ±‚æˆ–è¯­éŸ³æè¿°"
                                    rows="1"
                                ></textarea>
                            </div>
                            <button class="voice-button" id="voiceBtn" type="button" title="è¯­éŸ³è¾“å…¥">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                </svg>
                            </button>
                            <button class="send-button" id="sendButton" type="button">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                        <div class="bottom-hint">AIç”Ÿæˆä»…ä¾›å‚è€ƒ</div>
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                </ai-prompt-input>

                <!-- æˆ‘çš„ç©ºé—´é¢æ¿ï¼ˆåœ¨å¯¹è¯é¢æ¿å†…éƒ¨åˆ‡æ¢ï¼‰ -->
                <div class="my-space-panel" id="mySpacePanel">
                    <div class="my-space-content">
                        <div class="my-space-header">
                            <button class="my-space-back" id="mySpaceBackBtn">è¿”å›</button>
                            <div class="my-space-title" id="mySpaceTitle">æˆ‘çš„ç©ºé—´</div>
                            <div class="my-space-tabs">
                                <button class="my-space-tab active" data-tab="settings">è®¾ç½®</button>
                                <button class="my-space-tab" data-tab="resources">èµ„æº</button>
                            </div>
                        </div>
                        <div class="my-space-body">
                            <div class="my-space-section my-space-section-settings active">
                                <div class="my-settings-list">
                                    <div class="my-setting-card">
                                        <div class="my-setting-meta">
                                            <div class="my-setting-title">åŸºç¡€ä¿¡æ¯è®¾ç½®</div>
                                            <div class="my-setting-desc">å‰ç½®ä¸ªæ€§åŒ–èº«ä»½ä¿¡æ¯è®¾ç½®ï¼Œä¾‹å¦‚å¹´çº§ã€å­¦ç§‘ã€ä»»æ•™ç­çº§ç­‰ã€‚</div>
                                        </div>
                                    </div>

                                    <div class="my-setting-card">
                                        <div class="my-setting-meta">
                                            <div class="my-setting-title">å¤§æ¨¡å‹ç›¸å…³è®¾ç½®</div>
                                            <div class="my-setting-desc">æ¨¡å‹èƒ½åŠ›ä¸è°ƒç”¨ç­–ç•¥è®¾ç½®ï¼Œç”¨äºæ§åˆ¶ä¸åŒç±»å‹ä»»åŠ¡çš„æ•ˆæœã€‚</div>
                                        </div>
                                    </div>

                                    <div class="my-setting-card">
                                        <div class="my-setting-meta">
                                            <div class="my-setting-title">ä¸ªæ€§åŒ–åŠŸèƒ½è®¾ç½®</div>
                                            <div class="my-setting-desc">å¦‚ç³»ç»Ÿé»˜è®¤åŠŸèƒ½é…ç½®ã€å¸¸ç”¨æ¨¡æ¿ä¸åå¥½ä¿å­˜ç­‰ã€‚</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="my-space-section my-space-section-resources">
                                <div class="resources-group">
                                    <div class="resources-group-title">2025å¹´12æœˆ</div>
                                    <div class="resources-grid">
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;pic&gt;</div>
                                            <div class="resource-meta">å­¦æƒ…å›¾ç‰‡èµ„æº</div>
                                        </div>
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;video&gt;</div>
                                            <div class="resource-meta">è®²è§£è§†é¢‘èµ„æº</div>
                                        </div>
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;pic&gt;</div>
                                            <div class="resource-meta">æ¿ä¹¦æˆªå›¾</div>
                                        </div>
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;pdf&gt;</div>
                                            <div class="resource-meta">è¯•å·ä¸è®²ä¹‰ PDF</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="resources-group">
                                    <div class="resources-group-title">2025å¹´11æœˆ</div>
                                    <div class="resources-grid">
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;pic&gt;</div>
                                            <div class="resource-meta">é”™é¢˜å›¾ç‰‡</div>
                                        </div>
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;video&gt;</div>
                                            <div class="resource-meta">è¯¾å ‚å›æ”¾</div>
                                        </div>
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;pic&gt;</div>
                                            <div class="resource-meta">æ¿ä¹¦ç•™æ¡£</div>
                                        </div>
                                        <div class="resource-card">
                                            <div class="resource-name">&lt;pdf&gt;</div>
                                            <div class="resource-meta">çº¸è´¨èµ„æ–™æ‰«æä»¶</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é…ç½®é¢æ¿ -->
            <div class="config-panel" id="configPanel">
                <div class="config-status">
                    <div class="config-status-left">
                        <span class="config-status-label">ä½œä¸š</span>
                        <span>å·²ä¸ºæ‚¨åˆ›å»ºå¦‚ä¸‹é…ç½®ä½œä¸š,è¯·ç¡®è®¤åæ‰§è¡Œ</span>
                    </div>
                    <div class="config-status-right" id="configTime">2åˆ†é’Ÿå‰</div>
                </div>

                <div class="config-form">
                    <div class="form-group">
                        <label class="form-label">å­¦æ®µå­¦ç§‘</label>
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="text" class="form-input" value="æ•°å­¦" readonly>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <input type="text" class="form-input" placeholder="è¯·é€‰æ‹©" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ç‰ˆæœ¬åˆ†å†Œ</label>
                        <input type="text" class="form-input" value="äººæ•™ç‰ˆä¸ƒå¹´çº§ä¸Šå†Œ" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label optional">æ•™è¾…ç›®å½•</label>
                        <select class="form-select" id="textbookCatalog">
                            <option value="">è¯·é€‰æ‹©æ•™è¾…ç›®å½•</option>
                            <option value="ç¬¬ä¸€ç«  æœ‰ç†æ•°">ç¬¬ä¸€ç«  æœ‰ç†æ•°</option>
                            <option value="ç¬¬äºŒç«  æ•´å¼çš„åŠ å‡">ç¬¬äºŒç«  æ•´å¼çš„åŠ å‡</option>
                            <option value="ç¬¬ä¸‰ç«  ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹">ç¬¬ä¸‰ç«  ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹</option>
                            <option value="ç¬¬å››ç«  å‡ ä½•å›¾å½¢åˆæ­¥">ç¬¬å››ç«  å‡ ä½•å›¾å½¢åˆæ­¥</option>
                            <option value="ç¬¬äº”ç«  ç›¸äº¤çº¿ä¸å¹³è¡Œçº¿">ç¬¬äº”ç«  ç›¸äº¤çº¿ä¸å¹³è¡Œçº¿</option>
                            <option value="ç¬¬å…­ç«  å®æ•°">ç¬¬å…­ç«  å®æ•°</option>
                            <option value="ç¬¬ä¸ƒç«  å¹³é¢ç›´è§’åæ ‡ç³»">ç¬¬ä¸ƒç«  å¹³é¢ç›´è§’åæ ‡ç³»</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çŸ¥è¯†ç‚¹</label>
                        <textarea class="form-input form-textarea" readonly>ä¸‰è§’å½¢ä½™å¼¦å®šç†</textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é¢˜å‹</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="type1" checked>
                                <label for="type1">å•é€‰</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type2" checked>
                                <label for="type2">å¤šé€‰</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type3" checked>
                                <label for="type3">å¡«ç©º</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type4" checked>
                                <label for="type4">åˆ¤æ–­</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type5" checked>
                                <label for="type5">è§£ç­”</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type6" checked>
                                <label for="type6">ä½œå›¾</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ•°é‡</label>
                        <input type="text" class="form-input" value="10" readonly>
                        <span style="font-size: 13px; color: #999; margin-left: 8px;">é“(å«å°é¢˜)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä½œä¸šç±»å‹</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="homeworkType" id="typeTimed" checked>
                                <label for="typeTimed">é™æ—¶ä½œä¸š</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="homeworkType" id="typeClass">
                                <label for="typeClass">éšå ‚ä½œä¸š</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="homeworkType" id="typeExam">
                                <label for="typeExam">è€ƒè¯•æµ‹éªŒ</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="homeworkType" id="typeNormal">
                                <label for="typeNormal">æ™®é€šä½œä¸š</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‘å¸ƒå¯¹è±¡</label>
                        <div class="tag-group">
                            <span class="tag">2024çº§1ç­Aç»„</span>
                            <span class="tag">2024çº§1ç­Bç»„</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‘å¸ƒæ—¶é—´</label>
                        <input type="text" class="form-input" value="2025-12-08 20:00" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å…¶ä»–è¦æ±‚</label>
                        <textarea class="form-input form-textarea" placeholder="å¡«å…¥è¡¥å……ä¿¡æ¯"></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="btn" id="cancelBtn">å–æ¶ˆ</button>
                        <button class="btn" id="previewBtn">é¢„è§ˆ</button>
                        <button class="btn btn-primary" id="publishBtn">å‘å¸ƒ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ® AI ä¸»å…¥å£ -->
    <div class="ai-fab" id="aiFab">
        <div class="ai-fab-menu" id="aiFabMenu">
            <button class="ai-fab-item" data-function="analysis">
                <span>å­¦æƒ…åˆ†æ</span>
                <span class="ai-fab-item-tag">ç¤ºä¾‹</span>
            </button>
            <button class="ai-fab-item" data-function="imageEnhance">
                <span>å›¾ç‰‡ç¾åŒ–</span>
                <span class="ai-fab-item-tag">ç¤ºä¾‹</span>
            </button>
        </div>
        <button class="ai-fab-main" id="aiFabMain">
            <strong>AI</strong>
            <span>åŠ©æ‰‹</span>
        </button>
    </div>


    <script>
        // å®šä¹‰ AI Conversation Web Component
        class AIConversation extends HTMLElement {
            constructor() {
                super();
            }
            connectedCallback() {
                this.setAttribute('role', 'conversation');
            }
        }
        customElements.define('ai-conversation', AIConversation);

        // å®šä¹‰ AI Message Web Component
        class AIMessage extends HTMLElement {
            constructor() {
                super();
            }
            static get observedAttributes() {
                return ['role'];
            }
            connectedCallback() {
                this.setAttribute('role', this.getAttribute('role') || 'assistant');
            }
        }
        customElements.define('ai-message', AIMessage);

        // å®šä¹‰ AI Prompt Input Web Component
        class AIPromptInput extends HTMLElement {
            constructor() {
                super();
            }
            connectedCallback() {
                this.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = this.querySelector('textarea');
                    if (input && input.value.trim()) {
                        this.dispatchEvent(new CustomEvent('message-send', {
                            detail: { message: input.value.trim() },
                            bubbles: true
                        }));
                    }
                });
            }
        }
        customElements.define('ai-prompt-input', AIPromptInput);

        // åº”ç”¨çŠ¶æ€
        const appState = {
            currentFunction: 'homework',
            messages: [],
            uploadedImages: [],
            isProcessing: false
        };

        // DOM å…ƒç´ 
        const chatContent = document.getElementById('chatContent');
        const chatContainer = document.getElementById('chatContainer');
        const configPanel = document.getElementById('configPanel');
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const fileInput = document.getElementById('fileInput');
        const fileUploadBtn = document.getElementById('fileUploadBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const imagePreview = document.getElementById('imagePreview');
        const menuItems = document.querySelectorAll('.menu-item');
        const functionTitle = document.getElementById('functionTitle');
        const functionSubtitle = document.getElementById('functionSubtitle');
        const myBtn = document.getElementById('myBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const historyBtn = document.getElementById('historyBtn');
        const previewBtn = document.getElementById('previewBtn');
        const publishBtn = document.getElementById('publishBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const chatFeatureTitle = document.getElementById('chatFeatureTitle');
        const chatFeatureSubtitle = document.getElementById('chatFeatureSubtitle');
        const aiFabMain = document.getElementById('aiFabMain');
        const aiFabMenu = document.getElementById('aiFabMenu');
        const aiFabItems = document.querySelectorAll('.ai-fab-item');
        const mySpacePanel = document.getElementById('mySpacePanel');
        const mySpaceBackBtn = document.getElementById('mySpaceBackBtn');
        const mySpaceTitle = document.getElementById('mySpaceTitle');
        const mySpaceTabs = document.querySelectorAll('.my-space-tab');
        const mySpaceSections = {
            settings: document.querySelector('.my-space-section-settings'),
            resources: document.querySelector('.my-space-section-resources')
        };
        const chatCloseBtn = document.getElementById('chatCloseBtn');
        const chatMySpaceBtn = document.getElementById('chatMySpaceBtn');

        // åŠŸèƒ½é…ç½®
        const functionConfig = {
            history: { 
                title: 'ä¼šè¯è®°å½•', 
                subtitle: 'æŸ¥çœ‹å†å²ä¼šè¯è®°å½•',
                welcomeMessage: 'æ‚¨å¥½ï¼è¿™é‡Œæ˜¯ä¼šè¯è®°å½•åŠŸèƒ½ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å†å²ä¼šè¯è®°å½•ã€‚'
            },
            prep: { 
                title: 'ä¸€é”®å¤‡è¯¾', 
                subtitle: 'AIæ™ºèƒ½å¤‡è¯¾åŠ©æ‰‹',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯ä¸€é”®å¤‡è¯¾åŠ©æ‰‹ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦å‡†å¤‡ä»€ä¹ˆè¯¾ç¨‹ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨å¿«é€Ÿç”Ÿæˆå¤‡è¯¾æ–¹æ¡ˆã€‚'
            },
            homework: { 
                title: 'ä½œä¸šå¸ƒç½®', 
                subtitle: 'AIè‡ªåŠ¨å¸ƒç½®ä½œä¸š,è¯·æè¿°æ‚¨çš„è¦æ±‚å§',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯ä½œä¸šå¸ƒç½®åŠ©æ‰‹ã€‚è¯·é€šè¿‡è¯­éŸ³æˆ–æ–‡å­—æè¿°æ‚¨çš„ä½œä¸šéœ€æ±‚ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¤„ç†æ‚¨ä¸Šä¼ çš„å›¾ç‰‡ã€‚è®©æˆ‘æ¥å¸®æ‚¨å¸ƒç½®ä½œä¸šï¼',
                chatTagline: 'ä½œä¸šå¸ƒç½® Â· ä¸€é”®ç”Ÿæˆä¸ªæ€§åŒ–ç»ƒä¹ ä¸è¯•å·'
            },
            analysis: { 
                title: 'å­¦æƒ…åˆ†æ', 
                subtitle: 'æ™ºèƒ½åˆ†æå­¦ç”Ÿå­¦ä¹ æƒ…å†µ',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯å­¦æƒ…åˆ†æåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨åˆ†æå­¦ç”Ÿçš„å­¦ä¹ æƒ…å†µï¼Œç”Ÿæˆè¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚',
                chatTagline: 'å­¦æƒ…åˆ†æ Â· æ™ºèƒ½æ´å¯Ÿç­çº§å­¦ä¹ æƒ…å†µ'
            },
            imageEnhance: {
                title: 'å›¾ç‰‡ç¾åŒ–',
                subtitle: 'æ¸…æ™°åŒ–ã€æ’ç‰ˆä¼˜åŒ–è¯•é¢˜ä¸è¯¾ä»¶å›¾ç‰‡',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯å›¾ç‰‡ç¾åŒ–åŠ©æ‰‹ã€‚è¯·ä¸Šä¼ éœ€è¦å¤„ç†çš„å›¾ç‰‡ï¼Œæˆ‘ä¼šå¸®æ‚¨è‡ªåŠ¨å»å™ªã€å¢å¼ºä¸è£è¾¹ã€‚',
                chatTagline: 'å›¾ç‰‡ç¾åŒ– Â· æ™ºèƒ½æ¸…æ™°åŒ–ä¸ç‰ˆå¼ä¼˜åŒ–'
            },
            grading: { 
                title: 'ä½œæ–‡æ‰¹æ”¹', 
                subtitle: 'AIæ™ºèƒ½æ‰¹æ”¹ä½œæ–‡',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯ä½œæ–‡æ‰¹æ”¹åŠ©æ‰‹ã€‚è¯·ä¸Šä¼ å­¦ç”Ÿçš„ä½œæ–‡ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨è¿›è¡Œæ™ºèƒ½æ‰¹æ”¹å’Œè¯„åˆ†ã€‚'
            },
            export: { 
                title: 'æˆç»©å¯¼å‡º', 
                subtitle: 'å¯¼å‡ºå­¦ç”Ÿæˆç»©æ•°æ®',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æˆç»©å¯¼å‡ºåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨å¯¼å‡ºå­¦ç”Ÿçš„æˆç»©æ•°æ®ï¼Œæ”¯æŒå¤šç§æ ¼å¼ã€‚'
            },
            video: { 
                title: 'AIè§†é¢‘è®²é¢˜', 
                subtitle: 'ç”Ÿæˆè§†é¢‘è®²è§£é¢˜ç›®',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯AIè§†é¢‘è®²é¢˜åŠ©æ‰‹ã€‚è¯·æä¾›é¢˜ç›®ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨ç”Ÿæˆè§†é¢‘è®²è§£ã€‚'
            },
            ppt: { 
                title: 'è¯¾ä»¶PPT', 
                subtitle: 'æ™ºèƒ½ç”Ÿæˆè¯¾ä»¶PPT',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯è¯¾ä»¶PPTåŠ©æ‰‹ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„è¯¾ç¨‹ä¸»é¢˜å’Œå†…å®¹ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨ç”Ÿæˆç²¾ç¾çš„PPTè¯¾ä»¶ã€‚'
            },
            graphics: { 
                title: 'æ•°å­¦å›¾å½¢è®¾è®¡', 
                subtitle: 'è®¾è®¡æ•°å­¦å›¾å½¢',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ•°å­¦å›¾å½¢è®¾è®¡åŠ©æ‰‹ã€‚è¯·æè¿°æ‚¨éœ€è¦çš„æ•°å­¦å›¾å½¢ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨è®¾è®¡å’Œç»˜åˆ¶ã€‚'
            },
            grouping: { 
                title: 'æ™ºèƒ½åˆ†ç»„', 
                subtitle: 'æ™ºèƒ½åˆ†ç»„å­¦ç”Ÿ',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½åˆ†ç»„åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥æ ¹æ®å­¦ç”Ÿçš„ç‰¹ç‚¹å’Œå­¦ä¹ æƒ…å†µï¼Œå¸®æ‚¨è¿›è¡Œæ™ºèƒ½åˆ†ç»„ã€‚'
            },
            plan: { 
                title: 'æ•™å­¦è®¡åˆ’', 
                subtitle: 'åˆ¶å®šæ•™å­¦è®¡åˆ’',
                welcomeMessage: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ•™å­¦è®¡åˆ’åŠ©æ‰‹ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„æ•™å­¦ç›®æ ‡å’Œè¯¾ç¨‹å®‰æ’ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨åˆ¶å®šè¯¦ç»†çš„æ•™å­¦è®¡åˆ’ã€‚'
            }
        };

        // åˆ‡æ¢åŠŸèƒ½
        function switchFunction(functionName, keepMessages = false) {
            appState.currentFunction = functionName;
            
            // æ›´æ–°èœå•æ¿€æ´»çŠ¶æ€
            menuItems.forEach(item => {
                if (item.dataset.function === functionName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // æ›´æ–°æ ‡é¢˜
            const config = functionConfig[functionName] || functionConfig.homework;
            functionTitle.textContent = config.title;
            functionSubtitle.textContent = config.subtitle;
            if (chatFeatureTitle) {
                chatFeatureTitle.textContent = `AIåŠ©æ‰‹ Â· ${config.title}`;
            }
            if (chatFeatureSubtitle) {
                chatFeatureSubtitle.textContent = config.chatTagline || config.subtitle;
            }

            // é‡ç½®é…ç½®é¢æ¿çŠ¶æ€
            appState.showConfig = false;

            // æ ¹æ®åŠŸèƒ½æ˜¾ç¤ºä¸åŒç•Œé¢
            if (functionName === 'homework' && appState.showConfig) {
                // æ˜¾ç¤ºé…ç½®é¢æ¿
                chatContainer.style.display = 'none';
                configPanel.classList.add('active');
            } else {
                // æ˜¾ç¤ºèŠå¤©ç•Œé¢
                chatContainer.style.display = 'flex';
                configPanel.classList.remove('active');
                
                // å¦‚æœä¸æ˜¯ä¿æŒæ¶ˆæ¯ï¼Œåˆ™æ¸…ç©ºå¹¶æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                if (!keepMessages) {
                    chatContent.innerHTML = '';
                    appState.messages = [];
                    appState.uploadedImages = [];
                    imagePreview.innerHTML = '';
                    
                    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                    const welcomeMsg = config.welcomeMessage || 'æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ã€‚';
                    addMessage('assistant', welcomeMsg);

                    // é’ˆå¯¹éƒ¨åˆ†åŠŸèƒ½è¿½åŠ å¸¦æ“ä½œæŒ‰é’®ç»„çš„å¼•å¯¼æ¶ˆæ¯
                    if (functionName === 'analysis') {
                        const actionsHTML = `
                            <div class="message-actions">
                                <button class="message-action-btn primary" data-action="analysis-overview">ç”Ÿæˆç­çº§å­¦æƒ…æ€»è§ˆ</button>
                                <button class="message-action-btn" data-action="analysis-group-weak">æŒ‰å°ç»„æŸ¥çœ‹è–„å¼±çŸ¥è¯†ç‚¹</button>
                                <button class="message-action-btn" data-action="analysis-export-report">å¯¼å‡ºä¸ºå­¦æƒ…æŠ¥å‘Š</button>
                            </div>
                        `;
                        addMessage('assistant', 'æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ç‚¹å‡»ä¸‹é¢çš„å¿«æ·æ“ä½œå¼€å§‹å­¦æƒ…åˆ†æï¼š', [], actionsHTML);
                    } else if (functionName === 'imageEnhance') {
                        const actionsHTML = `
                            <div class="message-actions">
                                <button class="message-action-btn primary" data-action="image-enhance-quiz">ä¼˜åŒ–è¯•é¢˜ç…§ç‰‡</button>
                                <button class="message-action-btn" data-action="image-enhance-board">ç”Ÿæˆé«˜æ¸…æ¿ä¹¦å›¾ç‰‡</button>
                                <button class="message-action-btn" data-action="image-enhance-pdf">æ•´ç†ä¸ºè®²ä¹‰ PDF</button>
                            </div>
                        `;
                        addMessage('assistant', 'è¯·é€‰æ‹©éœ€è¦çš„å›¾ç‰‡å¤„ç†æ–¹å¼ï¼Œæˆ–ç›´æ¥ä¸Šä¼ å›¾ç‰‡è®©æˆ‘æ¥è¯†åˆ«ï¼š', [], actionsHTML);
                    } else if (functionName === 'homework') {
                        const actionsHTML = `
                            <div class="message-actions">
                                <button class="message-action-btn primary" data-action="homework-textbook">æŒ‰æ•™æç« èŠ‚æ™ºèƒ½å¸ƒç½®</button>
                                <button class="message-action-btn" data-action="homework-by-analysis">æ ¹æ®å­¦æƒ…å®šåˆ¶ä½œä¸š</button>
                                <button class="message-action-btn" data-action="homework-from-history">ä»å†å²ä½œä¸šå¿«é€Ÿå¤ç”¨</button>
                            </div>
                        `;
                        addMessage('assistant', 'æ‚¨å¯ä»¥é€‰æ‹©ä¸€ç§å¸ƒç½®æ–¹å¼ï¼Œæˆ–ç›´æ¥ç”¨è‡ªç„¶è¯­è¨€æè¿°æœ¬æ¬¡ä½œä¸šéœ€æ±‚ï¼š', [], actionsHTML);
                    }
                }
            }
        }

        // èœå•é¡¹ç‚¹å‡»äº‹ä»¶
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                switchFunction(item.dataset.function);
            });
        });

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        promptInput.addEventListener('input', () => {
            autoResizeTextarea(promptInput);
        });

        // è·å–ç›¸å¯¹æ—¶é—´
        function getRelativeTime() {
            return 'åˆšåˆš';
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯
        function addMessage(role, content, images = [], extraHTML = '') {
            const messageDiv = document.createElement('ai-message');
            messageDiv.setAttribute('role', role);
            
            const time = getRelativeTime();
            let imageHTML = '';
            if (images && images.length > 0) {
                imageHTML = '<div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">';
                images.forEach(img => {
                    imageHTML += `<img src="${img}" style="max-width: 200px; max-height: 200px; border-radius: 6px; border: 1px solid #e0e0e0;" />`;
                });
                imageHTML += '</div>';
            }
            
            const messageHTML = `
                <div class="message ${role}">
                    <div class="message-avatar">${role === 'user' ? 'U' : 'AI'}</div>
                    <div>
                        <div class="message-content">${content.replace(/\n/g, '<br>')}${imageHTML}${extraHTML}</div>
                        <div class="message-time">${time}</div>
                    </div>
                </div>
            `;
            
            messageDiv.innerHTML = messageHTML;
            chatContent.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                chatContent.scrollTop = chatContent.scrollHeight;
            }, 100);
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message assistant';
            typingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div>
                    <div class="typing-indicator">
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            chatContent.appendChild(typingDiv);
            chatContent.scrollTop = chatContent.scrollHeight;
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // é€šç”¨é—®ç­”å›å¤
        function handleGenericResponse(userMessage) {
            hideTypingIndicator();
            const responses = [
                `æˆ‘ç†è§£æ‚¨è¯´çš„æ˜¯ï¼š"${userMessage}"ã€‚è®©æˆ‘æ¥å¸®æ‚¨å¤„ç†ã€‚`,
                `å…³äº"${userMessage}"ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚`,
                `æ„Ÿè°¢æ‚¨çš„æé—®ï¼š"${userMessage}"ã€‚è®©æˆ‘æ¥åˆ†æä¸€ä¸‹ã€‚`
            ];
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addMessage('assistant', randomResponse);
        }

        // å­¦æƒ…åˆ†æç¤ºä¾‹æµç¨‹
        async function handleAnalysisRequest(userMessage, images) {
            await new Promise(resolve => setTimeout(resolve, 500));
            hideTypingIndicator();

            const analysisHTML = `
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div>
                        <div class="message-content">
                            å·²æ”¶åˆ°æ‚¨çš„å­¦æƒ…åˆ†æéœ€æ±‚ï¼Œå°†æŒ‰ä»¥ä¸‹æ­¥éª¤å¤„ç†æœ¬æ¬¡è¯·æ±‚ï¼š
                            <div class="task-list">
                                <div class="task-list-title">å­¦æƒ…åˆ†ææµç¨‹:</div>
                                <div class="task-item">
                                    <input type="checkbox" class="task-checkbox" disabled>
                                    <span>èšåˆæœ€è¿‘ä¸€æ¬¡ä½œä¸šä¸è€ƒè¯•æˆç»©ï¼ŒæŒ‰ç­çº§/å°ç»„ç»´åº¦å¯¹æ¯”</span>
                                </div>
                                <div class="task-item">
                                    <input type="checkbox" class="task-checkbox" disabled>
                                    <span>è¯†åˆ«é«˜é¢‘é”™é¢˜ä¸è–„å¼±çŸ¥è¯†ç‚¹</span>
                                </div>
                                <div class="task-item">
                                    <input type="checkbox" class="task-checkbox" disabled>
                                    <span>ç”Ÿæˆæ•™å­¦å»ºè®®ä¸åˆ†å±‚ä½œä¸šæ¨è</span>
                                </div>
                            </div>
                        </div>
                        <div class="message-time">åˆšåˆš</div>
                    </div>
                </div>
            `;

            const messageDiv = document.createElement('ai-message');
            messageDiv.setAttribute('role', 'assistant');
            messageDiv.innerHTML = analysisHTML;
            chatContent.appendChild(messageDiv);

            setTimeout(() => {
                const checkboxes = messageDiv.querySelectorAll('.task-checkbox');
                checkboxes.forEach(cb => cb.checked = true);
            }, 1500);

            setTimeout(() => {
                const summary = 'ç¤ºä¾‹å­¦æƒ…åˆ†æç»“è®ºï¼šæœ¬ç­æ•´ä½“æ­£ç¡®ç‡çº¦ä¸º 78%ï¼Œ"ä»£æ•°å¼åŒ–ç®€"ä¸"å‡½æ•°å›¾åƒ"é¢˜ç›®é”™è¯¯ç‡è¾ƒé«˜ï¼Œå»ºè®®å®‰æ’ 10 åˆ†é’Ÿé”™é¢˜å›é¡¾ï¼Œå¹¶ä¸ºåŸºç¡€è–„å¼±å­¦ç”Ÿæ¨é€å·©å›ºç»ƒä¹ ã€‚';
                const actionsHTML = `
                    <div class="message-actions">
                        <button class="message-action-btn primary" data-action="analysis-export-report">ç”Ÿæˆç­çº§å­¦æƒ…æŠ¥å‘Š</button>
                        <button class="message-action-btn" data-action="analysis-student-detail">æŒ‰å­¦ç”Ÿç»´åº¦æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="message-action-btn" data-action="analysis-generate-homework">ä¸ºè–„å¼±å­¦ç”Ÿç”Ÿæˆå·©å›ºä½œä¸š</button>
                    </div>
                `;
                addMessage('assistant', summary, [], actionsHTML);
            }, 2000);
        }

        // å›¾ç‰‡ç¾åŒ–ç¤ºä¾‹æµç¨‹
        async function handleImageEnhanceRequest(userMessage, images) {
            await new Promise(resolve => setTimeout(resolve, 500));
            hideTypingIndicator();
            const hasImages = images && images.length > 0;
            const content = hasImages
                ? 'æˆ‘å·²æ”¶åˆ°æ‚¨ä¸Šä¼ çš„å›¾ç‰‡ï¼Œå°†ä»æ¸…æ™°åº¦ã€å¯¹æ¯”åº¦ä¸è£å‰ªä¸‰ä¸ªç»´åº¦è¿›è¡Œè‡ªåŠ¨ä¼˜åŒ–ã€‚æœ¬ç¤ºä¾‹ä»…å±•ç¤ºæµç¨‹ï¼Œä¸ä¼šçœŸæ­£ä¿®æ”¹å›¾ç‰‡ã€‚'
                : `æ”¶åˆ°æ‚¨çš„å›¾ç‰‡ç¾åŒ–éœ€æ±‚ï¼š"${userMessage}"ã€‚æ‚¨å¯ä»¥ä¸Šä¼ éœ€è¦å¤„ç†çš„è¯•é¢˜æˆ–æ¿ä¹¦ç…§ç‰‡ï¼Œæˆ‘ä¼šä¸ºæ‚¨åšæ¸…æ™°åŒ–ä¸æ’ç‰ˆä¼˜åŒ–ï¼ˆæœ¬ç¤ºä¾‹ä»…åšæµç¨‹æ¼”ç¤ºï¼‰ã€‚`;
            let actionsHTML = '';
            if (hasImages) {
                actionsHTML = `
                    <div class="message-actions">
                        <button class="message-action-btn primary" data-action="image-download-optimized">ä¸‹è½½ä¼˜åŒ–åå›¾ç‰‡</button>
                        <button class="message-action-btn" data-action="image-replace-ppt">æ›¿æ¢è¯¾å ‚è¯¾ä»¶ä¸­çš„å›¾ç‰‡</button>
                        <button class="message-action-btn" data-action="image-to-pdf">æ•´ç†ä¸ºè®²ä¹‰ PDF</button>
                    </div>
                `;
            } else {
                actionsHTML = `
                    <div class="message-actions">
                        <button class="message-action-btn primary" data-action="image-upload-quiz">ä¸Šä¼ è¯•é¢˜å›¾ç‰‡</button>
                        <button class="message-action-btn" data-action="image-upload-board">ä¸Šä¼ æ¿ä¹¦ç…§ç‰‡</button>
                    </div>
                `;
            }
            addMessage('assistant', content, hasImages ? images : [], actionsHTML);
        }

        // å¤„ç†ä½œä¸šå¸ƒç½®è¯·æ±‚
        async function handleHomeworkRequest(userMessage, images) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä½œä¸šå¸ƒç½®è¯·æ±‚
            const homeworkKeywords = ['ä½œä¸š', 'å¸ƒç½®', 'å‘å¸ƒ', 'é¢˜ç›®', 'é¢˜ç›®', 'ç­çº§', 'ç»„'];
            const isHomeworkRequest = homeworkKeywords.some(keyword => userMessage.includes(keyword));

            if (!isHomeworkRequest || appState.currentFunction !== 'homework') {
                handleGenericResponse(userMessage);
                return;
            }

            if (isHomeworkRequest && appState.currentFunction === 'homework') {
                // æ˜¾ç¤ºä»»åŠ¡è§„åˆ’
                await new Promise(resolve => setTimeout(resolve, 500));
                hideTypingIndicator();
                
                const taskListHTML = `
                    <div class="message assistant">
                        <div class="message-avatar">AI</div>
                        <div>
                            <div class="message-content">
                                æ­£åœ¨å¸®æ‚¨è§„åˆ’ä»»åŠ¡....
                                <div class="task-list">
                                    <div class="task-list-title">ä»»åŠ¡æ¸…å•:</div>
                                    <div class="task-item">
                                        <input type="checkbox" class="task-checkbox" disabled>
                                        <span>è·å–"æˆ‘"çš„ä»»è¯¾ä¿¡æ¯ä¸ä½¿ç”¨æ•™æç‰ˆæœ¬,ç¡®è®¤é¢˜åº“ä¸ç« èŠ‚è¯¾æ—¶</span>
                                    </div>
                                    <div class="task-item">
                                        <input type="checkbox" class="task-checkbox" disabled>
                                        <span>è·å–ç­çº§ä¸åˆ†ç»„ä¿¡æ¯</span>
                                    </div>
                                    <div class="task-item">
                                        <input type="checkbox" class="task-checkbox" disabled>
                                        <span>ç”Ÿæˆä½œä¸šé…ç½®:ä½œä¸šåç§°ã€å‘å¸ƒå¯¹è±¡ã€å®šæ—¶ã€é™æ—¶ç­‰é…ç½®</span>
                                    </div>
                                </div>
                                <div class="tool-monitor">
                                    <div class="tool-monitor-title">æ­¤å¤„æ˜¯å·¥å…·è°ƒç”¨ingç›‘æ§æ»šåŠ¨åˆ—è¡¨</div>
                                    <div class="tool-item">
                                        <span>user="æ•™å¸ˆå§“å"&class="2024çº§1ç­"&group="A&B"</span>
                                        <span class="tool-status success">æ‰§è¡ŒæˆåŠŸ</span>
                                    </div>
                                    <div class="tool-item">
                                        <span>user="æ•™å¸ˆå§“å"&class="2024çº§1ç­"&group="A&B"</span>
                                        <span class="tool-status success">æ‰§è¡ŒæˆåŠŸ</span>
                                    </div>
                                    <div class="tool-item">
                                        <span>user="æ•™å¸ˆå§“å"&class="2024çº§1ç­"&group="A&B"</span>
                                        <span class="tool-status processing">è¿›è¡Œä¸­</span>
                                    </div>
                                </div>
                            </div>
                            <div class="message-time">åˆšåˆš</div>
                        </div>
                    </div>
                `;
                
                const messageDiv = document.createElement('ai-message');
                messageDiv.setAttribute('role', 'assistant');
                messageDiv.innerHTML = taskListHTML;
                chatContent.appendChild(messageDiv);
                
                // æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œåˆ‡æ¢åˆ°é…ç½®é¢æ¿
                setTimeout(() => {
                    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                    const checkboxes = messageDiv.querySelectorAll('.task-checkbox');
                    checkboxes.forEach(cb => cb.checked = true);
                    
                    // åˆ‡æ¢åˆ°é…ç½®é¢æ¿
                    setTimeout(() => {
                        chatContainer.style.display = 'none';
                        configPanel.classList.add('active');
                        appState.showConfig = true;
                    }, 1000);
                }, 2000);
                
                return;
            }
        }

        // æ ¹æ®å½“å‰åŠŸèƒ½åˆ†å‘è¯·æ±‚å¤„ç†
        async function handleRequest(userMessage, images) {
            if (appState.currentFunction === 'homework') {
                await handleHomeworkRequest(userMessage, images);
            } else if (appState.currentFunction === 'analysis') {
                await handleAnalysisRequest(userMessage, images);
            } else if (appState.currentFunction === 'imageEnhance') {
                await handleImageEnhanceRequest(userMessage, images);
            } else {
                handleGenericResponse(userMessage);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const messageText = promptInput.value.trim();
            const images = [...appState.uploadedImages];
            
            if (!messageText && images.length === 0) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (messageText) {
                addMessage('user', messageText, images);
                appState.messages.push({ role: 'user', content: messageText, images });
            }

            // æ¸…ç©ºè¾“å…¥æ¡†å’Œå›¾ç‰‡
            promptInput.value = '';
            promptInput.style.height = 'auto';
            appState.uploadedImages = [];
            imagePreview.innerHTML = '';
            
            // ç¦ç”¨å‘é€æŒ‰é’®
            sendButton.disabled = true;
            appState.isProcessing = true;

            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showTypingIndicator();

            try {
                // å¤„ç†è¯·æ±‚
                await handleRequest(messageText, images);
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚');
                console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
            } finally {
                // å¯ç”¨å‘é€æŒ‰é’®
                sendButton.disabled = false;
                appState.isProcessing = false;
                promptInput.focus();
            }
        }

        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendButton.addEventListener('click', sendMessage);

        // å›è½¦é”®å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // æ–‡ä»¶ä¸Šä¼ 
        fileUploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        appState.uploadedImages.push(imageUrl);
                        
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-preview-item';
                        imageItem.innerHTML = `
                            <img src="${imageUrl}" alt="é¢„è§ˆ">
                            <button class="remove-btn" onclick="this.parentElement.remove(); appState.uploadedImages = appState.uploadedImages.filter(img => img !== '${imageUrl}');">Ã—</button>
                        `;
                        imagePreview.appendChild(imageItem);
                    };
                    reader.readAsDataURL(file);
                }
            });
            fileInput.value = '';
        });

        // è¯­éŸ³è¾“å…¥ï¼ˆæ¨¡æ‹Ÿï¼‰
        voiceBtn.addEventListener('click', () => {
            if (appState.isRecording) {
                // åœæ­¢å½•éŸ³
                appState.isRecording = false;
                voiceBtn.style.background = 'white';
                alert('è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼šæ¨¡æ‹Ÿåœæ­¢å½•éŸ³');
            } else {
                // å¼€å§‹å½•éŸ³
                appState.isRecording = true;
                voiceBtn.style.background = '#ff4d4f';
                alert('è¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼šæ¨¡æ‹Ÿå¼€å§‹å½•éŸ³ï¼Œè¯·è¯´è¯...');
            }
        });

        // æ¶ˆæ¯å†…æ“ä½œæŒ‰é’® - äº‹ä»¶å§”æ‰˜
        const actionProcessConfig = {
            'analysis-overview': {
                title: 'æ­£åœ¨ç”Ÿæˆç­çº§å­¦æƒ…æ€»è§ˆ',
                steps: [
                    'èšåˆæœ€è¿‘ä¸¤æ¬¡ä½œä¸šä¸è€ƒè¯•æˆç»©',
                    'æŒ‰ç­çº§ / å°ç»„ / å­¦ç”Ÿç»´åº¦å¯¹æ¯”è¡¨ç°',
                    'ç”Ÿæˆç­çº§å­¦æƒ…æ€»è§ˆä¸å…³é”®ç»“è®º'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šç­çº§æ•´ä½“æ­£ç­”ç‡ 80%ï¼ŒA ç»„è¡¨ç°ç¨³å®šï¼ŒB ç»„åœ¨å‡½æ•°åº”ç”¨é¢˜ä¸Šå­˜åœ¨æ˜æ˜¾è–„å¼±ï¼Œå¯ç»“åˆæŠ¥å‘Šå®‰æ’é’ˆå¯¹æ€§è®²è¯„ã€‚'
            },
            'analysis-group-weak': {
                title: 'æ­£åœ¨åˆ†æå„å°ç»„è–„å¼±çŸ¥è¯†ç‚¹',
                steps: [
                    'ç»Ÿè®¡å„å°ç»„é”™é¢˜åˆ†å¸ƒ',
                    'æ˜ å°„åˆ°çŸ¥è¯†ç‚¹ä¸é¢˜å‹',
                    'è¾“å‡ºæ¯ä¸ªå°ç»„çš„è–„å¼±æ¸…å•'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šB ç»„åœ¨â€œä»£æ•°å¼åŒ–ç®€â€ã€C ç»„åœ¨â€œå›¾åƒè¯»æ•°â€ä¸Šé”™è¯¯ç‡è¾ƒé«˜ï¼Œå»ºè®®å®‰æ’åˆ†ç»„äº’åŠ©ä¸é’ˆå¯¹æ€§è®­ç»ƒã€‚'
            },
            'analysis-export-report': {
                title: 'æ­£åœ¨ç”Ÿæˆå­¦æƒ…åˆ†ææŠ¥å‘Šï¼ˆç¤ºä¾‹ï¼‰',
                steps: [
                    'æ±‡æ€»æˆç»©ä¸ä½œç­”æ•°æ®',
                    'æ•´ç†æ–‡å­—ç»“è®ºä¸æ”¹è¿›å»ºè®®',
                    'ç”Ÿæˆå¯ä¸‹è½½çš„æŠ¥å‘Šæ–‡ä»¶é“¾æ¥'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå­¦æƒ…æŠ¥å‘Šå·²ç”Ÿæˆï¼ˆç¤ºä¾‹ï¼‰ï¼Œå®é™…æ¥å…¥åå¯åœ¨â€œæˆ‘çš„-èµ„æºâ€ä¸­æŸ¥çœ‹å¹¶ä¸‹è½½ PDF æŠ¥å‘Šã€‚'
            },
            'analysis-student-detail': {
                title: 'æ­£åœ¨æ•´ç†å­¦ç”Ÿç»´åº¦å­¦æƒ…è¯¦æƒ…',
                steps: [
                    'æ‹‰å–å­¦ç”Ÿå†å²æˆç»©ä¸ä½œä¸šè®°å½•',
                    'è®¡ç®—ä¸ªäººæŒæ¡åº¦ä¸è¿›æ­¥å¹…åº¦',
                    'æŒ‰ä»ä½åˆ°é«˜æ’åºç”Ÿæˆæ¸…å•'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå·²æŒ‰æŒæ¡åº¦ä»ä½åˆ°é«˜åˆ—å‡ºå­¦ç”Ÿå­¦æƒ…æ¸…å•ï¼Œå¯æ®æ­¤è¿›è¡Œåˆ†å±‚è¾…å¯¼ä¸å®¶æ ¡æ²Ÿé€šï¼ˆæ¼”ç¤ºæ•°æ®ï¼‰ã€‚'
            },
            'analysis-generate-homework': {
                title: 'æ­£åœ¨ä¸ºè–„å¼±å­¦ç”Ÿç”Ÿæˆå·©å›ºä½œä¸š',
                steps: [
                    'å®šä½è–„å¼±çŸ¥è¯†ç‚¹ä¸é¢˜å‹',
                    'ä»é¢˜åº“ä¸­ç­›é€‰åŒ¹é…ç»ƒä¹ ',
                    'ç”Ÿæˆåˆ†å±‚ç»ƒä¹ æ¸…å•'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå·²ä¸ºè–„å¼±å­¦ç”Ÿç”Ÿæˆ 10 é“é’ˆå¯¹æ€§å·©å›ºé¢˜ï¼ˆæ¼”ç¤ºï¼‰ï¼Œå¯ä½œä¸ºä¸‹ä¸€æ¬¡ä½œä¸šæˆ–è¯¾åç»ƒä¹ ä½¿ç”¨ã€‚'
            },
            'image-enhance-quiz': {
                title: 'æ­£åœ¨ä¼˜åŒ–è¯•é¢˜ç…§ç‰‡',
                steps: [
                    'è‡ªåŠ¨è£å‰ªå¤šä½™è¾¹æ¡†',
                    'å¢å¼ºå¯¹æ¯”åº¦ä¸æ¸…æ™°åº¦',
                    'ç»Ÿä¸€ç‰ˆå¼ä»¥ä¾¿æ‰“å°ä¸å±•ç¤º'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šè¯•é¢˜ç…§ç‰‡å·²å®Œæˆä¼˜åŒ–ï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åå¯ç›´æ¥ä¸‹è½½é«˜æ¸…å›¾ç‰‡æˆ–æ’å…¥åˆ°è¯¾ä»¶ä¸­ã€‚'
            },
            'image-enhance-board': {
                title: 'æ­£åœ¨ç”Ÿæˆé«˜æ¸…æ¿ä¹¦å›¾ç‰‡',
                steps: [
                    'å»é™¤èƒŒæ™¯å™ªç‚¹ä¸åå…‰',
                    'å¢å¼ºç²‰ç¬”ç¬”è¿¹æ¸…æ™°åº¦',
                    'è°ƒæ•´å°ºå¯¸ä»¥é€‚é…å¤§å±å±•ç¤º'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šæ¿ä¹¦å›¾ç‰‡å·²é«˜æ¸…åŒ–ï¼ˆæ¼”ç¤ºï¼‰ï¼Œé€‚åˆç”¨äºè¯¾åèµ„æ–™æ²‰æ·€ä¸è¯¾å ‚å›é¡¾ã€‚'
            },
            'image-enhance-pdf': {
                title: 'æ­£åœ¨æ•´ç†å›¾ç‰‡ä¸ºè®²ä¹‰ PDF',
                steps: [
                    'æŒ‰é¢˜ç›®é¡ºåºæ’åˆ—å›¾ç‰‡',
                    'ç»Ÿä¸€é¡µè¾¹è·ä¸æ¯”ä¾‹',
                    'ç”Ÿæˆå¯æ‰“å°çš„è®²ä¹‰ PDF'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šè®²ä¹‰ PDF å·²ç”Ÿæˆï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åä¼šè‡ªåŠ¨åŒæ­¥åˆ°â€œæˆ‘çš„-èµ„æºâ€ä¸­ã€‚'
            },
            'image-download-optimized': {
                title: 'å‡†å¤‡ä¸‹è½½ä¼˜åŒ–åçš„å›¾ç‰‡',
                steps: [
                    'æ‰“åŒ…ä¼˜åŒ–åçš„å›¾ç‰‡èµ„æº',
                    'ç”Ÿæˆä¸´æ—¶ä¸‹è½½é“¾æ¥',
                    'æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå›¾ç‰‡å·²å‡†å¤‡å¥½ä¸‹è½½ï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åç‚¹å‡»ä¸‹è½½å³å¯è·å¾—ä¼˜åŒ–æ–‡ä»¶ã€‚'
            },
            'image-replace-ppt': {
                title: 'æ­£åœ¨æ›¿æ¢è¯¾ä»¶ä¸­çš„å›¾ç‰‡',
                steps: [
                    'å®šä½è¯¾ä»¶ä¸­çš„åŸå§‹å›¾ç‰‡ä½ç½®',
                    'æ›¿æ¢ä¸ºé«˜æ¸…ä¼˜åŒ–ç‰ˆæœ¬',
                    'æ›´æ–°è¯¾ä»¶å¹¶ä¿å­˜æ–°ç‰ˆæœ¬'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šè¯¾ä»¶å›¾ç‰‡å·²æ›¿æ¢ä¸ºé«˜æ¸…ç‰ˆæœ¬ï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åå¯åœ¨è¯¾ä»¶ç®¡ç†ä¸­æŸ¥çœ‹ã€‚'
            },
            'image-to-pdf': {
                title: 'æ­£åœ¨æ•´ç†ä¸ºè®²ä¹‰ PDF',
                steps: [
                    'åˆå¹¶å¤šå¼ å›¾ç‰‡',
                    'ç”Ÿæˆ PDF é¡µé¢',
                    'ä¸ºæ¯é¡µæ·»åŠ é¡µç ä¸æ ‡é¢˜'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šè®²ä¹‰ PDF å·²ç”Ÿæˆï¼ˆæ¼”ç¤ºï¼‰ï¼Œå¯åœ¨â€œæˆ‘çš„-èµ„æºâ€ä¸­æŸ¥çœ‹ã€‚'
            },
            'image-upload-quiz': {
                title: 'ç­‰å¾…ä¸Šä¼ è¯•é¢˜å›¾ç‰‡',
                steps: [
                    'å¼•å¯¼æ•™å¸ˆé€‰æ‹©æœ¬åœ°è¯•é¢˜ç…§ç‰‡',
                    'è¯†åˆ«æ‹æ‘„è§’åº¦ä¸æ¸…æ™°åº¦',
                    'å‡†å¤‡è¿›å…¥å›¾ç‰‡ä¼˜åŒ–æµç¨‹'
                ],
                finalMessage: 'æ‚¨å¯ä»¥é€šè¿‡ä¸‹æ–¹ä¸Šä¼ å…¥å£é€‰æ‹©è¯•é¢˜å›¾ç‰‡ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›å…¥ä¼˜åŒ–ä¸ç‰ˆå¼æ•´ç†æµç¨‹ï¼ˆæ¼”ç¤ºï¼‰ã€‚'
            },
            'image-upload-board': {
                title: 'ç­‰å¾…ä¸Šä¼ æ¿ä¹¦ç…§ç‰‡',
                steps: [
                    'å¼•å¯¼æ•™å¸ˆæ‹æ‘„æˆ–é€‰æ‹©æ¿ä¹¦ç…§ç‰‡',
                    'è‡ªåŠ¨æ£€æµ‹çœ©å…‰ä¸é®æŒ¡',
                    'å‡†å¤‡è¿›å…¥æ¿ä¹¦é«˜æ¸…åŒ–æµç¨‹'
                ],
                finalMessage: 'è¯·ä¸Šä¼ æ¿ä¹¦ç…§ç‰‡ï¼Œç³»ç»Ÿä¼šå°è¯•å»é™¤å™ªç‚¹å¹¶æé«˜æ¸…æ™°åº¦ï¼ˆæ¼”ç¤ºï¼‰ã€‚'
            },
            'homework-textbook': {
                title: 'æ­£åœ¨æŒ‰æ•™æç« èŠ‚æ™ºèƒ½å¸ƒç½®ä½œä¸š',
                steps: [
                    'è¯»å–å½“å‰æ•™æç‰ˆæœ¬ä¸ç« èŠ‚',
                    'ä»é¢˜åº“ä¸­ç­›é€‰åŒ¹é…é¢˜ç›®',
                    'ç”Ÿæˆæœ¬æ¬¡ä½œä¸šé…ç½®è‰ç¨¿'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå·²æ ¹æ®æ•™æç« èŠ‚ç”Ÿæˆä¸€ä»½åŒ…å«åŸºç¡€é¢˜ä¸æå‡é¢˜çš„ä½œä¸šè‰ç¨¿ï¼Œæ‚¨å¯ä»¥åœ¨å³ä¾§é…ç½®é¢æ¿ä¸­è¿›ä¸€æ­¥è°ƒæ•´åå‘å¸ƒã€‚'
            },
            'homework-by-analysis': {
                title: 'æ­£åœ¨æ ¹æ®å­¦æƒ…å®šåˆ¶ä½œä¸š',
                steps: [
                    'åˆ†ææœ€è¿‘å­¦æƒ…æŠ¥å‘Šä¸­çš„è–„å¼±ç‚¹',
                    'åŒ¹é…ç›¸å…³é¢˜ç›®ä¸é¢˜å‹',
                    'ç”Ÿæˆå·®å¼‚åŒ–ä½œä¸šæ–¹æ¡ˆ'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå·²æŒ‰å­¦æƒ…ç»“æœä¸ºä¸åŒå°ç»„ç”Ÿæˆå·®å¼‚åŒ–ä½œä¸šï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åä¼šè‡ªåŠ¨å¸¦å‡ºå…·ä½“é¢˜ç›®ä¸å‘å¸ƒå¯¹è±¡ã€‚'
            },
            'homework-from-history': {
                title: 'æ­£åœ¨ä»å†å²ä½œä¸šä¸­å¿«é€Ÿå¤ç”¨',
                steps: [
                    'æ£€ç´¢æœ€è¿‘å‘å¸ƒçš„åŒç±»å‹ä½œä¸š',
                    'è¿‡æ»¤å·²ä½¿ç”¨è¿‡çš„é¢˜ç›®',
                    'ç”Ÿæˆå¯å¤ç”¨ä½œä¸šè‰ç¨¿'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå·²ä¸ºæ‚¨å¤ç”¨ä¸€ä»½å†å²ä½œä¸šï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åå¯åœ¨é…ç½®é¢æ¿ä¸­æŒ‰éœ€å¢åˆ é¢˜ç›®ã€‚'
            },
            'homework-view-detail': {
                title: 'æ­£åœ¨ä¸ºæ‚¨æ‰“å¼€ä½œä¸šè¯¦æƒ…',
                steps: [
                    'åŠ è½½æœ¬æ¬¡ä½œä¸šçš„é…ç½®å‚æ•°',
                    'æ±‡æ€»é¢˜ç›®ä¸å‘å¸ƒå¯¹è±¡ä¿¡æ¯',
                    'å‡†å¤‡ä½œä¸šé¢„è§ˆç•Œé¢'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šä½œä¸šè¯¦æƒ…å·²å°±ç»ªï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åå°†ç›´æ¥æ‰“å¼€é¢„è§ˆå¼¹çª—ã€‚'
            },
            'homework-share-group': {
                title: 'æ­£åœ¨å‡†å¤‡åˆ†äº«åˆ°æ•™ç ”ç¾¤',
                steps: [
                    'æ•´ç†ä½œä¸šæ¦‚è¦ä¿¡æ¯',
                    'ç”Ÿæˆåˆ†äº«é“¾æ¥ä¸æ‘˜è¦',
                    'æ¨é€åˆ°æŒ‡å®šæ•™ç ”ç¾¤æˆ–åä½œç©ºé—´'
                ],
                finalMessage: 'ç¤ºä¾‹ç»“æœï¼šå·²å°†æœ¬æ¬¡ä½œä¸šåˆ†äº«è‡³æ•™ç ”åä½œç©ºé—´ï¼ˆæ¼”ç¤ºï¼‰ï¼Œå®é™…æ¥å…¥åå¯åœ¨ç¾¤èŠæˆ–åä½œå¹³å°ä¸­æŸ¥çœ‹ã€‚'
            }
        };

        async function runActionProcess(actionKey) {
            const config = actionProcessConfig[actionKey];
            if (!config) {
                handleGenericResponse(`æ“ä½œï¼š${actionKey}`);
                return;
            }

            appState.isProcessing = true;
            showTypingIndicator();
            await new Promise(resolve => setTimeout(resolve, 500));
            hideTypingIndicator();

            const stepsHTML = config.steps.map(step => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" disabled>
                    <span>${step}</span>
                </div>
            `).join('');

            const processHTML = `
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div>
                        <div class="message-content">
                            ${config.title}
                            <div class="task-list">
                                <div class="task-list-title">ä»»åŠ¡æ¸…å•:</div>
                                ${stepsHTML}
                            </div>
                        </div>
                        <div class="message-time">${getRelativeTime()}</div>
                    </div>
                </div>
            `;

            const processDiv = document.createElement('ai-message');
            processDiv.setAttribute('role', 'assistant');
            processDiv.innerHTML = processHTML;
            chatContent.appendChild(processDiv);

            setTimeout(() => {
                const checkboxes = processDiv.querySelectorAll('.task-checkbox');
                checkboxes.forEach(cb => cb.checked = true);
            }, 1200);

            setTimeout(() => {
                addMessage('assistant', config.finalMessage);
                appState.isProcessing = false;
            }, 2200);
        }

        chatContent.addEventListener('click', (event) => {
            const btn = event.target.closest('.message-action-btn');
            if (!btn) return;
            const action = btn.dataset.action;
            if (!action || appState.isProcessing) return;
            runActionProcess(action);
        });

        // æ‰“å¼€/å…³é—­æˆ‘çš„ç©ºé—´
        function setMySpaceTab(tab) {
            mySpaceTabs.forEach(btn => {
                const isActive = btn.dataset.tab === tab;
                btn.classList.toggle('active', isActive);
            });
            if (mySpaceSections.settings) {
                mySpaceSections.settings.classList.toggle('active', tab === 'settings');
            }
            if (mySpaceSections.resources) {
                mySpaceSections.resources.classList.toggle('active', tab === 'resources');
            }
            if (mySpaceTitle) {
                mySpaceTitle.textContent = tab === 'resources' ? 'æˆ‘çš„-èµ„æº' : 'æˆ‘çš„-è®¾ç½®';
            }
        }

        function openMySpace(defaultTab = 'settings') {
            if (!mySpacePanel) return;
            chatContainer.classList.add('my-space-open');
            setMySpaceTab(defaultTab);
        }

        function closeMySpace() {
            if (!mySpacePanel) return;
            chatContainer.classList.remove('my-space-open');
        }

        if (myBtn) {
            myBtn.addEventListener('click', () => {
                openMySpace('settings');
            });
        }

        // æ–°å»ºä¼šè¯æŒ‰é’®
        newChatBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ–°å»ºä¼šè¯å—ï¼Ÿå½“å‰ä¼šè¯å°†è¢«æ¸…ç©ºã€‚')) {
                const currentFunction = appState.currentFunction;
                chatContent.innerHTML = '';
                appState.messages = [];
                appState.uploadedImages = [];
                imagePreview.innerHTML = '';
                appState.showConfig = false;
                chatContainer.style.display = 'flex';
                configPanel.classList.remove('active');
                
                // æ·»åŠ å½“å‰åŠŸèƒ½çš„æ¬¢è¿æ¶ˆæ¯
                const config = functionConfig[currentFunction] || functionConfig.homework;
                addMessage('assistant', config.welcomeMessage || 'æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®åŠ©æ‚¨ã€‚');
            }
        });

        // å†å²è®°å½•æŒ‰é’®
        historyBtn.addEventListener('click', () => {
            alert('å†å²è®°å½•åŠŸèƒ½ï¼šæŸ¥çœ‹å½“å‰åŠ©ç†çš„å†å²ä¼šè¯è®°å½•');
            // è¿™é‡Œå¯ä»¥æ‰“å¼€å†å²è®°å½•é¢æ¿æˆ–å¼¹çª—
        });

        // é¢„è§ˆæŒ‰é’®
        previewBtn.addEventListener('click', () => {
            alert('é¢„è§ˆåŠŸèƒ½ï¼šæŸ¥çœ‹ä½œä¸šé¢„è§ˆæ•ˆæœ');
        });

        // å–æ¶ˆæŒ‰é’®
        cancelBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦å–æ¶ˆæœ¬æ¬¡é…ç½®å—ï¼Ÿå°†è¿”å›èŠå¤©ç•Œé¢ã€‚')) {
                appState.showConfig = false;
                chatContainer.style.display = 'flex';
                configPanel.classList.remove('active');
                
                // æ·»åŠ æç¤ºæ¶ˆæ¯
                addMessage('assistant', 'å·²å–æ¶ˆæœ¬æ¬¡ä½œä¸šé…ç½®ï¼Œæ‚¨å¯ä»¥é‡æ–°æè¿°æ‚¨çš„éœ€æ±‚ã€‚');
            }
        });

        // å­˜å‚¨å·²å‘å¸ƒçš„ä½œä¸šé…ç½®
        let publishedHomeworkConfig = null;

        // å‘å¸ƒæŒ‰é’®
        publishBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦å‘å¸ƒè¿™ä»½ä½œä¸šå—ï¼Ÿ')) {
                // æ”¶é›†é…ç½®ä¿¡æ¯ - ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
                const form = document.querySelector('.config-form');
                const subjectInputs = form.querySelectorAll('.form-row .form-input');
                const subject = Array.from(subjectInputs).map(input => input.value).filter(Boolean).join(' - ');
                
                const configData = {
                    subject: subject || '',
                    version: Array.from(form.querySelectorAll('.form-group')).find(g => {
                        const label = g.querySelector('label');
                        return label && label.textContent.includes('ç‰ˆæœ¬åˆ†å†Œ');
                    })?.querySelector('.form-input')?.value || '',
                    catalog: document.getElementById('textbookCatalog')?.value || '',
                    knowledge: form.querySelector('textarea.form-textarea[readonly]')?.value || '',
                    questionTypes: Array.from(form.querySelectorAll('.checkbox-item input:checked')).map(cb => {
                        const label = cb.nextElementSibling;
                        return label?.textContent?.trim();
                    }).filter(Boolean),
                    count: Array.from(form.querySelectorAll('.form-group')).find(g => {
                        const label = g.querySelector('label');
                        return label && label.textContent.includes('æ•°é‡');
                    })?.querySelector('.form-input')?.value || '',
                    homeworkType: (() => {
                        const checked = form.querySelector('input[name="homeworkType"]:checked');
                        return checked?.nextElementSibling?.textContent?.trim() || '';
                    })(),
                    publishTarget: Array.from(form.querySelectorAll('.tag')).map(tag => tag.textContent?.trim()).filter(Boolean),
                    publishTime: Array.from(form.querySelectorAll('.form-group')).find(g => {
                        const label = g.querySelector('label');
                        return label && label.textContent.includes('å‘å¸ƒæ—¶é—´');
                    })?.querySelector('.form-input')?.value || '',
                    otherRequirements: form.querySelector('textarea.form-textarea:not([readonly])')?.value || ''
                };
                publishedHomeworkConfig = configData;

                // å‘å¸ƒæˆåŠŸåï¼Œè¿”å›èŠå¤©ç•Œé¢å¹¶æ˜¾ç¤ºæ¶ˆæ¯å’ŒæŸ¥çœ‹æŒ‰é’®
                appState.showConfig = false;
                chatContainer.style.display = 'flex';
                configPanel.classList.remove('active');
                
                // æ·»åŠ å‘å¸ƒæˆåŠŸçš„æ¶ˆæ¯ï¼ŒåŒ…å«æŸ¥çœ‹æŒ‰é’®ç»„
                const extraHTML = `
                    <div class="message-actions">
                        <button class="message-action-btn primary" data-action="homework-view-detail">æŸ¥çœ‹ä½œä¸šè¯¦æƒ…</button>
                        <button class="message-action-btn" data-action="homework-share-group">åˆ†äº«åˆ°æ•™ç ”ç¾¤</button>
                    </div>
                `;
                addMessage('assistant', 'ä½œä¸šå·²æˆåŠŸå‘å¸ƒï¼', [], extraHTML);
            }
        });

        // ä½œä¸šé¢„è§ˆåŠŸèƒ½
        function showHomeworkPreview() {
            if (!publishedHomeworkConfig) {
                alert('æš‚æ— ä½œä¸šé…ç½®ä¿¡æ¯');
                return;
            }

            // åˆ›å»ºæ¨¡æ€æ¡†
            let modal = document.getElementById('homeworkPreviewModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'homeworkPreviewModal';
                modal.className = 'homework-preview-modal';
                modal.innerHTML = `
                    <div class="homework-preview-content">
                        <div class="homework-preview-header">
                            <h3>ä½œä¸šè¯¦æƒ…é¢„è§ˆ</h3>
                            <button class="homework-preview-close" onclick="closeHomeworkPreview()">Ã—</button>
                        </div>
                        <div class="homework-preview-body" id="homeworkPreviewBody">
                            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ç‚¹å‡»é®ç½©å±‚å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeHomeworkPreview();
                    }
                });
            }

            // å¡«å……é¢„è§ˆå†…å®¹
            const body = document.getElementById('homeworkPreviewBody');
            const config = publishedHomeworkConfig;
            body.innerHTML = `
                <div class="preview-item">
                    <div class="preview-label">å­¦æ®µå­¦ç§‘</div>
                    <div class="preview-value">${config.subject}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">ç‰ˆæœ¬åˆ†å†Œ</div>
                    <div class="preview-value">${config.version}</div>
                </div>
                ${config.catalog ? `
                <div class="preview-item">
                    <div class="preview-label">æ•™è¾…ç›®å½•</div>
                    <div class="preview-value">${config.catalog}</div>
                </div>
                ` : ''}
                <div class="preview-item">
                    <div class="preview-label">çŸ¥è¯†ç‚¹</div>
                    <div class="preview-value">${config.knowledge}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">é¢˜å‹</div>
                    <div class="preview-tags">
                        ${config.questionTypes.map(type => `<span class="preview-tag">${type}</span>`).join('')}
                    </div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">æ•°é‡</div>
                    <div class="preview-value">${config.count} é“(å«å°é¢˜)</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">ä½œä¸šç±»å‹</div>
                    <div class="preview-value">${config.homeworkType}</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">å‘å¸ƒå¯¹è±¡</div>
                    <div class="preview-tags">
                        ${config.publishTarget.map(target => `<span class="preview-tag">${target}</span>`).join('')}
                    </div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">å‘å¸ƒæ—¶é—´</div>
                    <div class="preview-value">${config.publishTime}</div>
                </div>
                ${config.otherRequirements ? `
                <div class="preview-item">
                    <div class="preview-label">å…¶ä»–è¦æ±‚</div>
                    <div class="preview-value">${config.otherRequirements}</div>
                </div>
                ` : ''}
            `;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.add('active');
        }

        // å…³é—­ä½œä¸šé¢„è§ˆ
        function closeHomeworkPreview() {
            const modal = document.getElementById('homeworkPreviewModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­çš„onclickå¯ä»¥ä½¿ç”¨
        window.showHomeworkPreview = showHomeworkPreview;
        window.closeHomeworkPreview = closeHomeworkPreview;

        // æ‚¬æµ®å…¥å£äº¤äº’
        if (aiFabMain && aiFabMenu) {
            aiFabMain.addEventListener('click', () => {
                aiFabMenu.classList.toggle('open');
            });
        }

        aiFabItems.forEach(btn => {
            btn.addEventListener('click', () => {
                const fn = btn.dataset.function || 'analysis';
                switchFunction(fn);
                chatContainer.style.display = 'flex';
                aiFabMenu.classList.remove('open');
            });
        });

        if (chatCloseBtn) {
            chatCloseBtn.addEventListener('click', () => {
                chatContainer.style.display = 'none';
            });
        }

        if (chatMySpaceBtn) {
            chatMySpaceBtn.addEventListener('click', () => {
                openMySpace('settings');
            });
        }

        if (mySpaceBackBtn) {
            mySpaceBackBtn.addEventListener('click', () => {
                closeMySpace();
            });
        }

        mySpaceTabs.forEach(tabBtn => {
            tabBtn.addEventListener('click', () => {
                setMySpaceTab(tabBtn.dataset.tab);
            });
        });
    </script>
</body>
</html>
